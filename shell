#!/bin/bash

# --- CONFIGURATION ---
CSV_FILE=$1
ACTION=$2
PARAM=$3

# Chronomètre (début) - Utilise date pour les millisecondes
START_TIME=$(date +%s%3N)

# --- FONCTION ERREUR ---
error_exit() {
    echo "Erreur : $1"
    # Affichage du temps même en cas d'erreur
    END_TIME=$(date +%s%3N)
    echo "Durée totale : $((END_TIME - START_TIME)) ms"
    exit 1
}

# --- VÉRIFICATIONS ARGUMENTS ---
[ $# -ne 3 ] && error_exit "Nombre d'arguments incorrect. Usage: $0 <file> <histo|leaks> <param>"
[ ! -f "$CSV_FILE" ] && error_exit "Fichier $CSV_FILE introuvable."

# --- COMPILATION ---
if [ ! -f "./wildwater" ]; then
    make > /dev/null 2>&1 || error_exit "La compilation a échoué."
fi

# --- TRAITEMENT ---
if [ "$ACTION" == "histo" ]; then
    # Vérification du sous-argument
    [[ "$PARAM" != "max" && "$PARAM" != "src" && "$PARAM" != "real" ]] && error_exit "Valeur histo incorrecte (max|src|real)."
    
    # Appel C (on passe -h car ton code C attend probablement -h)
    ./wildwater "$CSV_FILE" -h "$PARAM" > /dev/null
    [ $? -ne 0 ] && error_exit "Le programme C a renvoyé une erreur."

    # GnuPlot (Top 10 / Bottom 50)
    RAW_DATA="histo_${PARAM}.dat"
    grep -v "id" "$RAW_DATA" | sort -t';' -k2,2rn | head -n 10 > "top10_${PARAM}.temp"
    grep -v "id" "$RAW_DATA" | sort -t';' -k2,2n | head -n 50 > "bottom50_${PARAM}.temp"
    
    gnuplot -e "data_file='top10_${PARAM}.temp'; out_file='top10_${PARAM}.png'; main_title='Top 10 ($PARAM)'; unite='k.m3'" histo_config.gp
    gnuplot -e "data_file='bottom50_${PARAM}.temp'; out_file='bottom50_${PARAM}.png'; main_title='Bottom 50 ($PARAM)'; unite='k.m3'" histo_config.gp
    
    rm -f *.temp
    echo "Traitement histo $PARAM terminé."

elif [ "$ACTION" == "leaks" ]; then
    # Appel C pour les fuites
    ./wildwater "$CSV_FILE" -l "$PARAM"
    [ $? -ne 0 ] && error_exit "Erreur lors du calcul des fuites pour $PARAM."
else
    error_exit "Argument inconnu : $ACTION (attendu: histo ou leaks)."
fi

# --- CHRONO FIN ---
END_TIME=$(date +%s%3N)
echo "Durée totale : $((END_TIME - START_TIME)) ms"
