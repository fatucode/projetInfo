#!/usr/bin/env bash

BIN=wildwater
MAKEFILE=Makefile

usage() {
    echo "Usage:"
    echo "  $0 <csv_file> histo <max|src|real|all>"
    echo "  $0 <csv_file> leaks <plant_id>"
    exit 1
}

[ $# -lt 3 ] && usage

CSV="$1"
MODE="$2"
ARG="$3"

[ ! -f "$CSV" ] && echo "CSV file not found" && exit 1

if [ ! -x "$BIN" ]; then
    echo "Compiling C program..."
    make || exit 1
fi

START=$(date +%s%N)

case "$MODE" in
    histo)
        case "$ARG" in
            max|src|real|all)
                echo "Running histogram ($ARG)..."
                ./"$BIN" "$CSV" histo "$ARG" || exit 1
                if [ "$ARG" = "all" ]; then
                    echo "Generating plots..."
                    gnuplot histo_low.gp
                    gnuplot histo_high.gp
                fi
                ;;
            *)
                usage
                ;;
        esac
        ;;
    leaks)
        echo "Running leaks calculation for plant:"
        echo "$ARG"
        ./"$BIN" "$CSV" leaks "$ARG" || exit 1
        ;;
    *)
        usage
        ;;
esac

END=$(date +%s%N)
ELAPSED=$(( (END - START) / 1000000 ))

echo "Execution time: ${ELAPSED} ms"
